<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Автошкола - Тестирование</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --light-color: #f5f5f5;
            --dark-color: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            line-height: 1.6;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            text-align: center;
        }

        .mode-selection {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: var(--secondary-color);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .active-mode {
            font-weight: bold;
            transform: scale(1.05);
        }

        .exam-setup, .test-area, .results-area {
            display: none;
        }

        .question-navigation {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .question-number {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e0e0e0;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .question-number:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .question-number.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        /* В режиме обучения кружки окрашиваются по верности */
        .question-number.correct {
            background-color: var(--success-color);
            color: white;
        }

        .question-number.incorrect {
            background-color: var(--danger-color);
            color: white;
        }

        /* В режиме экзамена просто отмечаем, что на вопрос дан ответ */
        .question-number.answered {
            background-color: #a0a0a0;
            color: white;
        }

        .question-area {
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .explanation-button{
            margin-top: 10px;
        }

        /* Фиксированный размер изображения */
        .question-image {
            margin: 0 auto 10px auto;
            width: 100%;
            max-width: 500px;
            height: auto;
            /*margin-bottom: 20px;*/
            display: block;
        }

        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .answer-option {
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .answer-option:hover {
            background-color: #e0e0e0;
        }

        .answer-option.selected {
            background-color: var(--primary-color);
            color: white;
        }

        .answer-option.correct {
            background-color: var(--success-color);
            color: white;
        }

        .answer-option.incorrect {
            background-color: var(--danger-color);
            color: white;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .explanation {
            background-color: #f8f9fa;
            border-left: 4px solid var(--info-color);
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .timer {
            font-size: 24px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .results-summary {
            text-align: center;
            margin-bottom: 20px;
        }

        .results-details {
            margin-top: 20px;
        }

        .result-item {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .result-item:last-child {
            border-bottom: none;
        }


        .bilet-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .bilet-button {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bilet-button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Стилизация выпадающего списка для выбора билета в обучении */
        #training-ticket-select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            margin-left: 10px;
        }

        /* Центрирование кнопки завершения теста */
        #finish-test {
            display: block;
            margin: 20px auto;
        }

        /* Стили для модального окна подтверждения */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            width: 300px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<header>
    <div class="container">
        <h1>Автошкола - Система тестирования</h1>
    </div>
</header>

<div class="container">
    <div class="mode-selection">
        <button id="training-mode" class="btn btn-primary">Режим обучения</button>
        <button id="exam-mode" class="btn btn-primary">Режим экзамена</button>
    </div>

    <!-- Экзамен: настройка билета -->
    <div id="exam-setup" class="exam-setup card">
        <h2>Настройка экзамена</h2>
        <div id="bilet-selection" class="bilet-selection">
            <!-- Кнопки билетов будут добавлены динамически -->
        </div>
        <button id="random-bilet" class="btn btn-warning">Случайный билет</button>
        <div id="exam-time" class="timer">Время: 00:00</div>
        <button id="start-exam" class="btn btn-success">Начать экзамен</button>
    </div>

    <!-- Область тестирования (общая для обучения и экзамена) -->
    <div id="test-area" class="test-area card">
        <div id="exam-timer" class="timer hidden">Осталось: 00:00</div>
        <!-- Выпадающий список для выбора билета в обучении -->
        <div id="training-ticket-container" style="margin-bottom: 20px; display: none;">
            <label for="training-ticket-select">Выберите билет: </label>
            <select id="training-ticket-select"></select>
        </div>
        <div id="question-navigation" class="question-navigation">
            <!-- Номера вопросов будут добавлены динамически -->
        </div>
        <div id="question-area" class="question-area">
            <h3 id="question-number">Вопрос 1</h3>
            <p id="question-text" class="question-text"></p>
            <img id="question-image" class="question-image" src="" alt="Изображение к вопросу" style="display: none;">
            <div id="answer-options" class="answer-options">
                <!-- Варианты ответов -->
            </div>
            <div id="explanation" class="explanation"></div>
            <button id="explanation-toggle" class="btn btn-info explanation-button hidden">Показать подсказку</button>
        </div>
        <div class="navigation-buttons">
            <button id="prev-question" class="btn btn-primary">Назад</button>
            <button id="next-question" class="btn btn-primary">Дальше</button>
        </div>
        <button id="finish-test" class="btn btn-danger">Завершить тест</button>
    </div>

    <!-- Область результатов -->
    <div id="results-area" class="results-area card">
        <h2>Результаты теста</h2>
        <div class="results-summary">
            <h3 id="score">Правильных ответов: 0 из 0</h3>
            <p id="time-taken">Затраченное время: 00:00</p>
        </div>
        <div id="results-details" class="results-details">
            <!-- Детали результатов -->
        </div>
        <button id="back-to-modes" class="btn btn-primary">Вернуться к выбору режима</button>
    </div>
</div>

<!-- Модальное окно для подтверждения завершения экзамена -->
<div id="confirm-modal" class="modal hidden">
    <div class="modal-content">
        <p>Вы не ответили на все вопросы. Вы уверены, что хотите завершить тест?</p>
        <button id="confirm-yes" class="btn btn-success">Да</button>
        <button id="confirm-no" class="btn btn-danger">Нет</button>
    </div>
</div>

<script>
    // Глобальные переменные
    let settings = {};            // Загружаются из settings.txt
    let biletData = {};           // Правильные ответы (из bilet.txt)
    let kommentData = {};         // Пояснения (из komment.txt)
    let questions = [];           // Массив объектов вопросов для выбранного билета

    let currentMode = '';         // 'training' или 'exam'
    let currentTicket = 1;        // Выбранный билет
    let currentQuestionIndex = 0; // Индекс текущего вопроса (0-indexed)
    let questionsCount = 0;       // Общее число вопросов билета
    let userAnswers = {};         // Ключ: "ticket-index", значение: номер выбранного ответа
    let timer = null;
    let remainingTime = 0;

    document.addEventListener('DOMContentLoaded', async () => {
        await loadSettings();
        await loadBiletData();
        await loadKommentData();
        initBiletSelection(); // для экзамена
        initTrainingTicketSelect(); // для обучения

        document.getElementById('training-mode').addEventListener('click', () => setMode('training'));
        document.getElementById('exam-mode').addEventListener('click', () => setMode('exam'));
        document.getElementById('random-bilet').addEventListener('click', selectRandomBilet);
        document.getElementById('start-exam').addEventListener('click', startExam);
        document.getElementById('prev-question').addEventListener('click', goToPrevQuestion);
        document.getElementById('next-question').addEventListener('click', goToNextQuestion);
        document.getElementById('explanation-toggle').addEventListener('click', toggleExplanation);
        document.getElementById('finish-test').addEventListener('click', finishTestHandler);
        document.getElementById('back-to-modes').addEventListener('click', backToModeSelection);

        // Обработчики для модального окна
        document.getElementById('confirm-yes').addEventListener('click', () => {
            hideModal();
            finishTest();
        });
        document.getElementById('confirm-no').addEventListener('click', hideModal);
    });

    // Загрузка настроек из settings.txt
    async function loadSettings() {
        try {
            const response = await fetch('settings.txt');
            const text = await response.text();
            const lines = text.split('\n').filter(line => line.trim() !== '');
            lines.forEach(line => {
                let [key, value] = line.split('=');
                if (key && value) {
                    settings[key.trim()] = value.trim();
                }
            });
            document.getElementById('exam-time').textContent = `Время: ${formatTime(parseInt(settings.time) || 1200)}`;
        } catch (error) {
            console.error("Ошибка загрузки settings.txt: " + error);
        }
    }

    // Загрузка правильных ответов из bilet.txt
    async function loadBiletData() {
        try {
            const response = await fetch('bilet.txt');
            const text = await response.text();
            const lines = text.split('\n').filter(line => line.trim() !== '');
            lines.forEach(line => {
                let parts = line.split('-');
                if (parts.length === 2) {
                    let answerKey = parts[0].trim();
                    let ticketNumber = parseInt(parts[1].trim());
                    biletData[ticketNumber] = answerKey;
                }
            });
        } catch (error) {
            console.error("Ошибка загрузки bilet.txt: " + error);
        }
    }

    // Загрузка комментариев из komment.txt
    async function loadKommentData() {
        try {
            const response = await fetch('komment.txt');
            const text = await response.text();
            const lines = text.split('\n');
            let currentTicketKey = null;
            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith("билет")) {
                    let num = parseInt(line.replace("билет", ""));
                    currentTicketKey = num;
                    kommentData[currentTicketKey] = {};
                } else if (currentTicketKey && line.match(/^\d+\./)) {
                    let dotIndex = line.indexOf('.');
                    let qNum = parseInt(line.substring(0, dotIndex));
                    kommentData[currentTicketKey][qNum] = line;
                }
            });
        } catch (error) {
            console.error("Ошибка загрузки komment.txt: " + error);
        }
    }

    // Инициализация кнопок билетов для экзамена
    function initBiletSelection() {
        const container = document.getElementById('bilet-selection');
        container.innerHTML = '';
        const total = parseInt(settings.bilets) || 0;
        for (let i = 1; i <= total; i++) {
            const btn = document.createElement('div');
            btn.className = 'bilet-button';
            btn.textContent = i;
            btn.dataset.bilet = i;
            btn.addEventListener('click', () => selectBilet(i));
            container.appendChild(btn);
        }
    }

    // Инициализация выпадающего списка для выбора билета в обучении
    function initTrainingTicketSelect() {
        const select = document.getElementById('training-ticket-select');
        select.innerHTML = '';
        const total = parseInt(settings.bilets) || 0;
        for (let i = 1; i <= total; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = "Билет " + i;
            select.appendChild(option);
        }
        select.addEventListener('change', () => {
            const newTicket = parseInt(select.value);
            loadBilet(newTicket);
        });
    }

    // Выбор билета (для экзамена)
    function selectBilet(biletNumber) {
        currentTicket = biletNumber;
        document.querySelectorAll('.bilet-button').forEach(btn => {
            if (parseInt(btn.dataset.bilet) === biletNumber) {
                btn.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
                btn.style.color = 'white';
            } else {
                btn.style.backgroundColor = '#e0e0e0';
                btn.style.color = '#333';
            }
        });
    }

    // Выбор случайного билета (для экзамена)
    function selectRandomBilet() {
        const total = parseInt(settings.bilets) || 0;
        const random = Math.floor(Math.random() * total) + 1;
        selectBilet(random);
    }

    // Установка режима: обучение или экзамен
    function setMode(mode) {
        currentMode = mode;
        userAnswers = {};
        clearInterval(timer);
        // Скрываем все области
        document.getElementById('exam-setup').style.display = 'none';
        document.getElementById('test-area').style.display = 'none';
        document.getElementById('results-area').style.display = 'none';
        document.querySelectorAll('.mode-selection button').forEach(btn => btn.classList.remove('active-mode'));
        if (mode === 'training') {
            document.getElementById('training-mode').classList.add('active-mode');
            // Показываем dropdown для выбора билета в обучении
            document.getElementById('training-ticket-container').style.display = 'block';
            loadBilet(1);
            document.getElementById('test-area').style.display = 'block';
            document.getElementById('exam-timer').classList.add('hidden');
            document.getElementById('finish-test').classList.add('hidden'); // В обучении кнопка скрыта
            document.getElementById('explanation-toggle').classList.remove('hidden');
        } else if (mode === 'exam') {
            document.getElementById('exam-mode').classList.add('active-mode');
            document.getElementById('exam-setup').style.display = 'block';
            document.getElementById('training-ticket-container').style.display = 'none';
            // В экзамене кнопка "Завершить тест" всегда включена и центрирована
            document.getElementById('finish-test').classList.remove('hidden');
        }
    }

    // Загрузка билета: загружаем вопросы выбранного билета и показываем первый вопрос
    async function loadBilet(ticketNumber) {
        currentTicket = ticketNumber;
        currentQuestionIndex = 0;
        await loadQuestions(ticketNumber);
        if (questions.length === 0) {
            alert("Вопросы для билета " + ticketNumber + " не найдены.");
            return;
        }
        questionsCount = questions.length;
        updateQuestionNavigation();
        displayQuestion();
    }

    // Загрузка вопросов для выбранного билета (с декодированием ANSI -> windows-1251)
    async function loadQuestions(ticket) {
        questions = [];
        let q = 1;
        while (true) {
            try {
                const response = await fetch(`gai/questions/${ticket}-${q}.txt`);
                if (!response.ok) break;
                const buffer = await response.arrayBuffer();
                let decoder = new TextDecoder('windows-1251');
                const text = decoder.decode(buffer);
                const lines = text.split(/\r?\n/).map(line => line.trim()).filter(line => line !== '');
                if (lines.length < 2) break;
                let questionObj = {
                    questionText: lines[0],
                    options: lines.slice(1),
                    correctAnswer: (biletData[ticket] && biletData[ticket].length >= q) ? parseInt(biletData[ticket].charAt(q - 1)) : null,
                    explanation: (kommentData[ticket] && kommentData[ticket][q]) || "",
                    image: `gai/images/Pdd_${String(ticket).padStart(2, '0')}_${String(q).padStart(2, '0')}.jpg`
                };
                questions.push(questionObj);
                q++;
            } catch (e) {
                console.error(e);
                break;
            }
        }
    }

    // Обновление навигации по вопросам
    function updateQuestionNavigation() {
        const nav = document.getElementById('question-navigation');
        nav.innerHTML = '';
        for (let i = 0; i < questionsCount; i++) {
            const btn = document.createElement('div');
            btn.className = 'question-number';
            btn.textContent = i + 1;
            btn.dataset.index = i;
            btn.addEventListener('click', () => {
                currentQuestionIndex = i;
                displayQuestion();
            });
            if (currentMode === 'training') {
                if (userAnswers[`${currentTicket}-${i}`]) {
                    const userAns = userAnswers[`${currentTicket}-${i}`];
                    const correctAns = questions[i].correctAnswer;
                    if (userAns === correctAns) {
                        btn.classList.add('correct');
                    } else {
                        btn.classList.add('incorrect');
                    }
                }
            } else if (currentMode === 'exam') {
                if (userAnswers[`${currentTicket}-${i}`]) {
                    btn.classList.add('answered');
                }
            }
            if (i === currentQuestionIndex) {
                btn.classList.add('active');
            }
            nav.appendChild(btn);
        }
    }

    // Отображение текущего вопроса
    function displayQuestion() {
        const qObj = questions[currentQuestionIndex];
        document.getElementById('question-number').textContent = `Вопрос ${currentQuestionIndex + 1}`;
        document.getElementById('question-text').textContent = qObj.questionText;

        // Работа с изображением
        const imgElem = document.getElementById('question-image');
        imgElem.style.display = 'none';
        imgElem.src = qObj.image;
        imgElem.onerror = function() {
            imgElem.onerror = null;
            imgElem.src = settings.path ? settings.path + "img.jpg" : "gai/img.jpg";
        };
        imgElem.onload = function() {
            imgElem.style.display = 'block';
        };

        // Варианты ответов
        const optionsDiv = document.getElementById('answer-options');
        optionsDiv.innerHTML = '';
        qObj.options.forEach((opt, idx) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'answer-option';
            optionDiv.textContent = opt;
            optionDiv.dataset.option = idx + 1;
            optionDiv.addEventListener('click', () => selectAnswer(idx + 1));
            if (userAnswers[`${currentTicket}-${currentQuestionIndex}`] === (idx + 1)) {
                optionDiv.classList.add('selected');
                if (currentMode === 'training') {
                    const correctAns = qObj.correctAnswer;
                    if ((idx + 1) === correctAns) {
                        optionDiv.classList.add('correct');
                    } else {
                        optionDiv.classList.add('incorrect');
                    }
                }
            }
            optionsDiv.appendChild(optionDiv);
        });

        // Скрываем пояснение и обновляем текст кнопки подсказки
        const expDiv = document.getElementById('explanation');
        expDiv.style.display = 'none';
        expDiv.textContent = "";
        document.getElementById('explanation-toggle').textContent = 'Показать подсказку';
        if (currentMode === 'training') {
            document.getElementById('explanation-toggle').classList.remove('hidden');
        } else {
            document.getElementById('explanation-toggle').classList.add('hidden');
        }

        updateQuestionNavigation();
    }

    // Обработка выбора ответа
    function selectAnswer(optionNumber) {
        const key = `${currentTicket}-${currentQuestionIndex}`;
        const qObj = questions[currentQuestionIndex];
        if (currentMode === 'training') {
            userAnswers[key] = optionNumber;
            updateAnswerUI();
            if (optionNumber !== qObj.correctAnswer) {
                const expDiv = document.getElementById('explanation');
                expDiv.textContent = qObj.explanation || "Подсказка отсутствует";
                expDiv.style.display = 'block';
                document.getElementById('explanation-toggle').textContent = 'Скрыть подсказку';
            } else {
                setTimeout(() => {
                    if (currentQuestionIndex < questionsCount - 1) {
                        currentQuestionIndex++;
                        displayQuestion();
                    } else {
                        alert("Вы прошли все вопросы билета.");
                    }
                }, 1000);
            }
        } else if (currentMode === 'exam') {
            userAnswers[key] = optionNumber;
            updateAnswerUI();
            updateQuestionNavigation();
        }
    }

    // Обновление отображения выбранных вариантов
    function updateAnswerUI() {
        const optionsDiv = document.getElementById('answer-options');
        Array.from(optionsDiv.children).forEach(optionElem => {
            optionElem.classList.remove('selected', 'correct', 'incorrect');
            const optionNumber = parseInt(optionElem.dataset.option);
            if (userAnswers[`${currentTicket}-${currentQuestionIndex}`] === optionNumber) {
                optionElem.classList.add('selected');
                if (currentMode === 'training') {
                    const correctAns = questions[currentQuestionIndex].correctAnswer;
                    if (optionNumber === correctAns) {
                        optionElem.classList.add('correct');
                    } else {
                        optionElem.classList.add('incorrect');
                    }
                }
            }
        });
    }

    // Переключение отображения подсказки (по кнопке)
    function toggleExplanation() {
        const expDiv = document.getElementById('explanation');
        const qObj = questions[currentQuestionIndex];
        if (expDiv.style.display === 'none' || expDiv.style.display === '') {
            expDiv.textContent = qObj.explanation || "Подсказка отсутствует";
            expDiv.style.display = 'block';
            document.getElementById('explanation-toggle').textContent = 'Скрыть подсказку';
        } else {
            expDiv.style.display = 'none';
            document.getElementById('explanation-toggle').textContent = 'Показать подсказку';
        }
    }

    // Переход к предыдущему вопросу
    function goToPrevQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            displayQuestion();
        }
    }

    // Переход к следующему вопросу
    function goToNextQuestion() {
        if (currentQuestionIndex < questionsCount - 1) {
            currentQuestionIndex++;
            displayQuestion();
        }
    }

    // Обработчик кнопки завершения теста в режиме экзамена
    function finishTestHandler() {
        if (currentMode === 'exam') {
            let unanswered = [];
            for (let i = 0; i < questionsCount; i++) {
                if (!userAnswers[`${currentTicket}-${i}`]) {
                    unanswered.push(i + 1);
                }
            }
            if (unanswered.length > 0) {
                showModal();
            } else {
                finishTest();
            }
        }
    }

    // Показ модального окна
    function showModal() {
        document.getElementById('confirm-modal').classList.remove('hidden');
    }

    // Скрыть модальное окно
    function hideModal() {
        document.getElementById('confirm-modal').classList.add('hidden');
    }

    // Начало экзамена: загрузка выбранного билета, запуск таймера и переход в область теста
    async function startExam() {
        userAnswers = {};
        document.getElementById('exam-setup').style.display = 'none';
        document.getElementById('test-area').style.display = 'block';
        document.getElementById('exam-timer').classList.remove('hidden');
        // Кнопка завершения теста всегда видна и расположена по центру
        document.getElementById('finish-test').style.display = 'block';
        await loadBilet(currentTicket);
        remainingTime = parseInt(settings.time) || 1200;
        updateTimer();
        timer = setInterval(updateTimer, 1000);
    }

    // Обновление таймера экзамена
    function updateTimer() {
        remainingTime--;
        if (remainingTime <= 0) {
            clearInterval(timer);
            finishTest();
            return;
        }
        document.getElementById('exam-timer').textContent = `Осталось: ${formatTime(remainingTime)}`;
    }

    // Форматирование времени (MM:SS)
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    // Завершение теста (для экзамена)
    function finishTest() {
        clearInterval(timer);
        let correctCount = 0;
        for (let i = 0; i < questionsCount; i++) {
            const key = `${currentTicket}-${i}`;
            const userAns = userAnswers[key];
            const correctAns = questions[i].correctAnswer;
            if (userAns === correctAns) {
                correctCount++;
            }
        }
        document.getElementById('test-area').style.display = 'none';
        document.getElementById('results-area').style.display = 'block';
        document.getElementById('score').textContent = `Правильных ответов: ${correctCount} из ${questionsCount}`;
        document.getElementById('time-taken').textContent = `Затраченное время: ${formatTime((parseInt(settings.time) || 1200) - remainingTime)}`;

        const resultsDetails = document.getElementById('results-details');
        resultsDetails.innerHTML = '';
        for (let i = 0; i < questionsCount; i++) {
            const qObj = questions[i];
            const key = `${currentTicket}-${i}`;
            const userAns = userAnswers[key];
            const correctAns = qObj.correctAnswer;
            const isCorrect = userAns === correctAns;
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.innerHTML = `
          <h4>Вопрос ${i + 1}: ${isCorrect ? '✓' : '✗'}</h4>
          <p>${qObj.questionText}</p>
          <p>Ваш ответ: ${userAns ? qObj.options[userAns - 1] : 'Не отвечено'}</p>
          ${!isCorrect ? `<p>Правильный ответ: ${qObj.options[correctAns - 1]}</p>` : ''}
          <button class="btn btn-info explanation-button" onclick="toggleResultExplanation(this)">Показать подсказку</button>
          <div class="explanation" style="display: none;">${qObj.explanation || "Подсказка отсутствует"}</div>
        `;
            resultsDetails.appendChild(resultItem);
        }
    }

    // Функция для переключения отображения пояснения в результатах
    function toggleResultExplanation(btn) {
        const expDiv = btn.nextElementSibling;
        if (expDiv.style.display === "none" || expDiv.style.display === "") {
            expDiv.style.display = "block";
            btn.textContent = "Скрыть подсказку";
        } else {
            expDiv.style.display = "none";
            btn.textContent = "Показать подсказку";
        }
    }

    // Возврат к выбору режима
    function backToModeSelection() {
        userAnswers = {};
        clearInterval(timer);
        document.getElementById('exam-setup').style.display = 'none';
        document.getElementById('test-area').style.display = 'none';
        document.getElementById('results-area').style.display = 'none';
        document.querySelectorAll('.mode-selection button').forEach(btn => btn.classList.remove('active-mode'));
        currentMode = '';
    }
</script>
</body>
</html>
